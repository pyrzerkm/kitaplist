<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>Kitap Listesi</title>
    <style>
        /* Aynı stil kodları */
        body { font-family: Arial, sans-serif; background-color: #f0f4f8; margin: 0; padding: 20px;}
        h1 { color: #333; text-align: center; }
        form, table { max-width: 800px; margin: auto; margin-bottom: 20px; }
        label { display: block; margin-top: 10px; }
        input, select { width: 100%; padding: 8px; margin-top: 4px; }
        button { margin-top: 12px; padding: 10px 15px; cursor: pointer; }
        table { margin-top: 30px; width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; background-color: #fff; border: 1px solid #ccc; }
        th { background-color: #e0e0e0; }
        .actions button { margin: 2px; }
        .favori { color: goldenrod; }
        .error { color: red; text-align: center; }
        .success { color: green; text-align: center; }
        /* Güncelleme formunu başlangıçta gizle */
        #kitapGuncelleForm { display: none; border: 1px solid #ccc; padding: 15px; background: #fff; }
    </style>
</head>
<body>

    <h1>📚 Kitap Listesi</h1>

    <div id="mesaj"></div>

    <!-- Kitap Ekleme Formu -->
    <form id="kitapEkleForm">
        <h2>Yeni Kitap Ekle</h2>
        <label for="baslikEkle">Başlık:</label>
        <input type="text" id="baslikEkle" required>

        <label for="yazarEkle">Yazar:</label>
        <input type="text" id="yazarEkle" required>

        <label for="yayin_yiliEkle">Yayın Yılı:</label>
        <input type="number" id="yayin_yiliEkle" required>

        <label for="sayfa_sayisiEkle">Sayfa Sayısı:</label>
        <input type="number" id="sayfa_sayisiEkle" required>

        <label for="turEkle">Tür:</label>
        <input type="text" id="turEkle">

        <label for="kategoriEkle">Kategori:</label>
        <select id="kategoriEkle" required>
            <option value="">Kategori Seç</option>
            <option>Bilim ve Mühendislik</option>
            <option>Çocuk Kitapları</option>
            <option>Açık Kaynak Kitapları</option>
            <option>Dil Kitapları</option>
            <option>Tarih Kitapları</option>
        </select>

        <button type="submit">📌 Kitap Ekle</button>
    </form>

    <!-- Kitap Güncelleme Formu -->
    <form id="kitapGuncelleForm">
        <h2>Kitap Güncelle</h2>
        <input type="hidden" id="kitapIdGuncelle">

        <label for="baslikGuncelle">Başlık:</label>
        <input type="text" id="baslikGuncelle" required>

        <label for="yazarGuncelle">Yazar:</label>
        <input type="text" id="yazarGuncelle" required>

        <label for="yayin_yiliGuncelle">Yayın Yılı:</label>
        <input type="number" id="yayin_yiliGuncelle" required>

        <label for="sayfa_sayisiGuncelle">Sayfa Sayısı:</label>
        <input type="number" id="sayfa_sayisiGuncelle" required>

        <label for="turGuncelle">Tür:</label>
        <input type="text" id="turGuncelle">

        <label for="kategoriGuncelle">Kategori:</label>
        <select id="kategoriGuncelle" required>
            <option value="">Kategori Seç</option>
            <option>Bilim ve Mühendislik</option>
            <option>Çocuk Kitapları</option>
            <option>Açık Kaynak Kitapları</option>
            <option>Dil Kitapları</option>
            <option>Tarih Kitapları</option>
        </select>

        <button type="submit">💾 Güncelle</button>
        <button type="button" id="iptalGuncelle">❌ İptal</button>
    </form>

    <table id="kitaplarTablosu">
        <thead>
            <tr>
                <th>ID</th>
                <th>Başlık</th>
                <th>Yazar</th>
                <th>Yıl</th>
                <th>Sayfa</th>
                <th>Tür</th>
                <th>Kategori</th>
                <th>Favori</th>
                <th>İşlemler</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

<script>
    const apiUrl = "http://localhost:8000";

    // Kitap Ekleme formu
    document.getElementById('kitapEkleForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const baslik = document.getElementById('baslikEkle').value;
        const yazar = document.getElementById('yazarEkle').value;
        const yayin_yili = parseInt(document.getElementById('yayin_yiliEkle').value);
        const sayfa_sayisi = parseInt(document.getElementById('sayfa_sayisiEkle').value);
        const tur = document.getElementById('turEkle').value;
        const kategori = document.getElementById('kategoriEkle').value;

        if (!kategori) {
            mesajGoster("⚠️ Kategori seçmelisiniz!", true);
            return;
        }

        const kitap = { baslik, yazar, yayin_yili, sayfa_sayisi, tur, kategori };

        try {
            const response = await fetch(`${apiUrl}/kitap-ekle/`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(kitap),
            });

            const data = await response.json();

            if (!response.ok) {
                mesajGoster("⚠️ " + data.detail, true);
                return;
            }

            mesajGoster("✅ Kitap başarıyla eklendi!");
            this.reset();
            kitaplariYukle();
        } catch (error) {
            mesajGoster("❌ Hata oluştu!", true);
        }
    });

    // Kitap Güncelleme formu
    document.getElementById('kitapGuncelleForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const kitapId = document.getElementById('kitapIdGuncelle').value;
        const baslik = document.getElementById('baslikGuncelle').value;
        const yazar = document.getElementById('yazarGuncelle').value;
        const yayin_yili = parseInt(document.getElementById('yayin_yiliGuncelle').value);
        const sayfa_sayisi = parseInt(document.getElementById('sayfa_sayisiGuncelle').value);
        const tur = document.getElementById('turGuncelle').value;
        const kategori = document.getElementById('kategoriGuncelle').value;

        if (!kategori) {
            mesajGoster("⚠️ Kategori seçmelisiniz!", true);
            return;
        }

        const kitap = { baslik, yazar, yayin_yili, sayfa_sayisi, tur, kategori };

        try {
            const response = await fetch(`${apiUrl}/kitap-guncelle/${kitapId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(kitap),
            });

            const data = await response.json();

            if (!response.ok) {
                mesajGoster("⚠️ " + data.detail, true);
                return;
            }

            mesajGoster("✅ Kitap başarıyla güncellendi!");
            this.reset();
            document.getElementById('kitapGuncelleForm').style.display = "none";
            kitaplariYukle();
        } catch (error) {
            mesajGoster("❌ Hata oluştu!", true);
        }
    });

    // İptal butonu güncelleme formunda
    document.getElementById('iptalGuncelle').addEventListener('click', function() {
        document.getElementById('kitapGuncelleForm').style.display = "none";
    });

    // Kitapları yükleme
    async function kitaplariYukle() {
        const response = await fetch(`${apiUrl}/kitaplar/`);
        const kitaplar = await response.json();
        const tbody = document.querySelector('#kitaplarTablosu tbody');
        tbody.innerHTML = "";

        kitaplar.forEach(k => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${k.id}</td>
                <td>${k.baslik}</td>
                <td>${k.yazar}</td>
                <td>${k.yayin_yili}</td>
                <td>${k.sayfa_sayisi}</td>
                <td>${k.tur}</td>
                <td>${k.kategori}</td>
                <td class="${k.favori ? 'favori' : ''}">${k.favori ? "⭐" : ""}</td>
                <td class="actions">
                    <button onclick="kitapguncelle(${k.id})">✏️ Güncelle
                    <button onclick="kitapSil(${k.id})">🗑️ Sil</button>
                    <button onclick="favoriDegistir(${k.id}, ${k.favori})">
                        ${k.favori ? "💔 Favoriden Çıkar" : "💖 Favori Yap"}
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // guncelleme butonuna basınca güncelleme formunu doldurup göster
    async function kitapguncelle(id) {
        const res = await fetch(`${apiUrl}/kitap/${id}`);
        const kitap = await res.json();

        document.getElementById('kitapIdGuncelle').value = kitap.id;
        document.getElementById('baslikGuncelle').value = kitap.baslik;
        document.getElementById('yazarGuncelle').value = kitap.yazar;
        document.getElementById('yayin_yiliGuncelle').value = kitap.yayin_yili;
        document.getElementById('sayfa_sayisiGuncelle').value = kitap.sayfa_sayisi;
        document.getElementById('turGuncelle').value = kitap.tur;
        document.getElementById('kategoriGuncelle').value = kitap.kategori;

        document.getElementById('kitapGuncelleForm').style.display = "block";
        window.scrollTo(0, document.body.scrollHeight);
    }

    async function kitapSil(id) {
        if (!confirm("Kitap silinsin mi?")) return;
        await fetch(`${apiUrl}/kitap-sil/${id}`, { method: "DELETE" });
        kitaplariYukle();
    }

    async function favoriDegistir(id, favoriMi) {
        const url = favoriMi
            ? `${apiUrl}/kitap/${id}/favori-kaldir/`
            : `${apiUrl}/kitap/${id}/favori/`;
        await fetch(url, { method: "POST" });
        kitaplariYukle();
    }

    function mesajGoster(mesaj, hata = false) {
        const mesajDiv = document.getElementById("mesaj");
        mesajDiv.textContent = mesaj;
        mesajDiv.className = hata ? "error" : "success";
        setTimeout(() => {
            mesajDiv.textContent = "";
            mesajDiv.className = "";
        }, 3000);
    }

    kitaplariYukle();
</script>

</body>
</html>
